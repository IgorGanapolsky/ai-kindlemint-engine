name: Autonomous KDP Publishing System

on:
  workflow_dispatch:
    inputs:
      volumes_to_publish:
        description: 'Volumes to publish (comma-separated, e.g., "1,2,3")'
        required: true
        default: '1'
        type: string
      force_republish:
        description: 'Force republish even if already published'
        required: false
        default: false
        type: boolean
      amazon_verification_code:
        description: 'Amazon verification code (if prompted via email/SMS)'
        required: false
        default: ''
        type: string

  schedule:
    # Auto-publish daily at 9 AM UTC
    - cron: '0 9 * * *'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  KDP_EMAIL: ${{ secrets.KDP_EMAIL }}
  KDP_PASSWORD: ${{ secrets.KDP_PASSWORD }}
  KDP_SESSION_COOKIES: ${{ secrets.KDP_SESSION_COOKIES }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
  NOVA_ACT_API_KEY: ${{ secrets.NOVA_ACT_API_KEY }}
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
  ENVIRONMENT: production
  CI: true
  DISPLAY: ":99"
  PLAYWRIGHT_BROWSERS_PATH: /ms-playwright

jobs:
  autonomous-kdp-publishing:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: 🚀 Checkout Repository
        uses: actions/checkout@v4
        
      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: 📦 Cache Python Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-python-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-
          
      - name: 📦 Install Chrome and Dependencies
        run: |
          # Install Chrome dependencies
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libxss1 \
            libasound2 \
            fonts-liberation \
            libappindicator3-1 \
            libgbm-dev \
            libgtk-3-0 \
            xvfb \
            wget \
            unzip
          
          # Install Google Chrome
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Install Python dependencies
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Install Playwright browsers with deps
          python -m playwright install chromium
          python -m playwright install-deps
          
      - name: 🔧 Setup Environment
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "KDP_EMAIL=${{ secrets.KDP_EMAIL }}" >> .env
          echo "KDP_PASSWORD=${{ secrets.KDP_PASSWORD }}" >> .env
          echo "NOVA_ACT_API_KEY=${{ secrets.NOVA_ACT_API_KEY }}" >> .env
          if [ -n "${{ github.event.inputs.amazon_verification_code }}" ]; then
            echo "AMAZON_VERIFICATION_CODE=${{ github.event.inputs.amazon_verification_code }}" >> .env
          fi
          
      - name: 🎨 Verify Covers Exist
        run: |
          python -c "
          from pathlib import Path
          import sys
          
          # Check new hierarchical structure
          brand_dir = Path('output/Senior_Puzzle_Studio/Large_Print_Crossword_Masters')
          missing_covers = []
          
          for vol in range(1, 6):
              vol_dir = brand_dir / f'volume_{vol}'
              cover_file = vol_dir / 'cover.png'
              if not cover_file.exists():
                  missing_covers.append(vol)
          
          if missing_covers:
              print(f'❌ Missing covers for volumes: {missing_covers}')
              sys.exit(1)
          else:
              print('✅ All covers present in Git LFS structure')
          "
          
      - name: 🔧 Generate KDP-Ready PDFs
        run: |
          python scripts/utilities/generate_kdp_pdfs.py
          
      - name: 🖥️ Start Virtual Display
        run: |
          # Start Xvfb for headless browser testing
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          
      - name: 📚 Autonomous KDP Publishing (Robust)
        run: |
          # Run with proper environment variables
          DISPLAY=:99 python scripts/publishing/robust_kdp_publisher.py
          
      - name: 📊 Generate Publishing Report
        run: |
          python scripts/automation/generate_publishing_report.py
          
      - name: 📧 Send Success Notification
        if: success()
        run: |
          python scripts/automation/send_success_notification.py \
            --workflow="${{ github.workflow }}" \
            --run-id="${{ github.run_id }}" \
            --run-url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --commit="${{ github.sha }}" \
            --commit-msg="${{ github.event.head_commit.message || github.event.commits[0].message || 'Manual workflow dispatch' }}" \
            --triggered-by="${{ github.actor }}" \
            --branch="${{ github.ref_name }}" \
            --volumes="${{ github.event.inputs.volumes_to_publish || '1' }}"
          
      - name: 🚨 Send Failure Notification
        if: failure()
        run: |
          python scripts/automation/send_failure_notification.py \
            --workflow="${{ github.workflow }}" \
            --run-id="${{ github.run_id }}" \
            --run-url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --commit="${{ github.sha }}" \
            --commit-msg="${{ github.event.head_commit.message || github.event.commits[0].message || 'Manual workflow dispatch' }}" \
            --triggered-by="${{ github.actor }}" \
            --branch="${{ github.ref_name }}" \
            --volumes="${{ github.event.inputs.volumes_to_publish || '1' }}" \
            --failed-step="${{ job.status }}"
          
      - name: 💾 Archive Publishing Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: publishing-logs-${{ github.run_number }}
          path: |
            logs/
            output/publishing_reports/
          retention-days: 30
          
  cleanup-old-artifacts:
    runs-on: ubuntu-latest
    if: always()
    needs: autonomous-kdp-publishing
    steps:
      - name: 🧹 Cleanup Old Artifacts
        uses: actions/github-script@v6
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const oldArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.name.startsWith('publishing-logs-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(10); // Keep only last 10
            
            for (const artifact of oldArtifacts) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }